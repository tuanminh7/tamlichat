<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MINDBUDDY</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1.2rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        
        .navbar h1 {
            font-size: 1.5rem;
            background: linear-gradient(135deg, #4fc3f7 0%, #66bb6a 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .navbar-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .navbar-right span {
            color: #2c3e50;
            font-weight: 600;
        }

        .navbar-right .btn-pet {
            color: white;
            text-decoration: none;
            padding: 0.6rem 1.2rem;
            background: linear-gradient(135deg, #4fc3f7 0%, #66bb6a 100%);
            border-radius: 25px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .navbar-right .btn-pet:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 195, 247, 0.4);
        }
        
        .navbar a.btn-logout {
            color: #e74c3c;
            text-decoration: none;
            padding: 0.5rem 1rem;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 5px;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .navbar a.btn-logout:hover {
            background: rgba(231, 76, 60, 0.2);
        }
        
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            overflow: hidden;
        }
        
        .chat-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #4fc3f7 0%, #66bb6a 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
            flex-shrink: 0;
        }
        
        .chat-header h2 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }
        
        .chat-header p {
            opacity: 0.9;
            font-size: 1rem;
        }
        
        .info-banner {
            background: linear-gradient(135deg, #e1f5fe 0%, #e8f5e9 100%);
            padding: 1rem 1.5rem;
            border-left: 4px solid #66bb6a;
            margin: 1rem 1.5rem 0;
            border-radius: 10px;
            font-size: 0.9rem;
            color: #555;
            flex-shrink: 0;
        }
        
        .info-banner strong {
            display: block;
            margin-bottom: 0.3rem;
            color: #66bb6a;
        }
        
        .chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background: #f8f9fa;
        }
        
        .chat-box::-webkit-scrollbar {
            width: 8px;
        }
        
        .chat-box::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .chat-box::-webkit-scrollbar-thumb {
            background: #66bb6a;
            border-radius: 4px;
        }
        
        .message {
            margin-bottom: 1.5rem;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .message-content {
            padding: 1rem 1.2rem;
            border-radius: 15px;
            line-height: 1.6;
            max-width: 80%;
        }
        
        .message.student {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .message.student .message-header {
            color: #4fc3f7;
        }
        
        .message.student .message-content {
            background: linear-gradient(135deg, #4fc3f7 0%, #66bb6a 100%);
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .message.bot {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .message.bot .message-header {
            color: #66bb6a;
        }
        
        .message.bot .message-content {
            background: white;
            color: #2c3e50;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .chat-input-container {
            padding: 1.5rem 2rem;
            background: white;
            border-top: 2px solid #f0f0f0;
            flex-shrink: 0;
        }
        
        .chat-input {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .chat-input input {
            flex: 1;
            padding: 1rem 1.5rem;
            border: 2px solid #b3e5fc;
            border-radius: 25px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .chat-input input:focus {
            outline: none;
            border-color: #4fc3f7;
            box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.1);
        }
        
        .btn-send {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #4fc3f7 0%, #66bb6a 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(79, 195, 247, 0.4);
        }
        
        .btn-send:active {
            transform: translateY(0);
        }
        
        .typing-indicator {
            display: none;
            padding: 1rem;
            background: white;
            border-radius: 15px;
            width: fit-content;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .typing-indicator.active {
            display: block;
        }
        
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #66bb6a;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>MINDBUDDY, xin chào</h1>
        <div class="navbar-right">
            <a href="/student/pet" class="btn-pet">Thú cưng</a>
            <span id="userName">Học sinh</span>
            <a href="/logout" class="btn-logout">Đăng xuất</a>
        </div>
    </nav>
    
    <div class="container">
        <div class="chat-container">
            <div class="chat-header">
                <h2>Trò chuyện với MINDBUDDY</h2>
                <p>Hãy thoải mái chia sẻ những suy nghĩ và cảm xúc của bạn. Chúng tôi luôn sẵn sàng lắng nghe.</p>
            </div>
            
            <div id="chatBox" class="chat-box">
                <div class="message bot">
                    <div class="message-header">
                        Chuyên viên tâm lý
                    </div>
                    <div class="message-content">
                        Xin chào! Tôi là trợ lý tâm lý của trường. Bạn có thể chia sẻ bất cứ điều gì đang khiến bạn lo lắng, buồn bã hoặc muốn tâm sự. Đừng ngần ngại nhé - tôi ở đây để lắng nghe và hỗ trợ bạn!
                    </div>
                </div>
                
                <div class="typing-indicator" id="typingIndicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            
            <div class="chat-input-container">
                <div class="chat-input">
                    <input 
                        type="text" 
                        id="messageInput" 
                        placeholder="Nhập tin nhắn của bạn..." 
                        onkeypress="if(event.key==='Enter') sendMessage()"
                    >
                    <button class="btn-send" onclick="sendMessage()">Gửi</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        async function loadChatHistory() {
            try {
                const response = await fetch('/student/chat/history');
                const data = await response.json();
                
                if (data.history && data.history.length > 0) {
                    const chatBox = document.getElementById('chatBox');
                    
                    data.history.forEach(conv => {
                        chatBox.innerHTML += `
                            <div class="message student">
                                <div class="message-header">
                                    Bạn
                                </div>
                                <div class="message-content">
                                    ${escapeHtml(conv.student_message)}
                                </div>
                            </div>
                            <div class="message bot">
                                <div class="message-header">
                                    Chuyên viên tâm lý
                                </div>
                                <div class="message-content">
                                    ${escapeHtml(conv.bot_response)}
                                </div>
                            </div>
                        `;
                    });
                    
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            } catch (error) {
                console.error('Lỗi tải lịch sử chat:', error);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;
            
            const chatBox = document.getElementById('chatBox');
            const typingIndicator = document.getElementById('typingIndicator');
            
            chatBox.innerHTML += `
                <div class="message student">
                    <div class="message-header">
                        Bạn
                    </div>
                    <div class="message-content">
                        ${escapeHtml(message)}
                    </div>
                </div>
            `;
            
            input.value = '';
            chatBox.scrollTop = chatBox.scrollHeight;
            
            typingIndicator.classList.add('active');
            chatBox.scrollTop = chatBox.scrollHeight;
            
            try {
                const response = await fetch('/student/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message})
                });
                
                const data = await response.json();
                
                typingIndicator.classList.remove('active');
                
                chatBox.innerHTML += `
                    <div class="message bot">
                        <div class="message-header">
                            Chuyên viên tâm lý
                        </div>
                        <div class="message-content">
                            ${escapeHtml(data.response)}
                        </div>
                    </div>
                `;
                chatBox.scrollTop = chatBox.scrollHeight;
            } catch (error) {
                typingIndicator.classList.remove('active');
                chatBox.innerHTML += `
                    <div class="message bot">
                        <div class="message-header">
                            Hệ thống
                        </div>
                        <div class="message-content">
                            Xin lỗi, đã có lỗi xảy ra. Vui lòng thử lại sau.
                        </div>
                    </div>
                `;
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        window.addEventListener('load', loadChatHistory);
    </script>
</body>
</html>